version: 1.0.{build}
pull_requests:
  do_not_increment_build_number: true
configuration: Release
platform: x64
clone_folder: C:\projects\myproject
init:
- cmd: git config --global core.autocrlf input
clone_script:
- cmd: "git clone -q --branch=%APPVEYOR_REPO_BRANCH% https://github.com/%APPVEYOR_REPO_NAME%.git %APPVEYOR_BUILD_FOLDER% \ncd %APPVEYOR_BUILD_FOLDER%\ngit checkout -q %APPVEYOR_REPO_COMMIT%\ngit submodule update --init --recursive"
environment:
  LIBRESSL_VERSION: 2.7.3
install:
- cmd: >-
    SET GIT_COMMIT=%APPVEYOR_REPO_COMMIT:~0,3%

    rd /s /q C:\OpenSSL-Win32

    rd /s /q C:\OpenSSL-Win64

    curl -fsSLO "https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-%LIBRESSL_VERSION%.tar.gz"

    7z x -so "libressl-%LIBRESSL_VERSION%.tar.gz" | 7z x -si -aoa -ttar

    mkdir "libressl-%LIBRESSL_VERSION%\build"

    cd "libressl-%LIBRESSL_VERSION%\build"

    cmake -G"Visual Studio 14 2015 Win64" -DCMAKE_INSTALL_PREFIX="C:/LibreSSL" ..

    cmake --build . --config Release --target INSTALL -- /m

    cd ..\..

    cmake -DRAIBLOCKS_SIMD_OPTIMIZATIONS=TRUE -DBOOST_INCLUDEDIR=C:/Libraries/boost_1_66_0 -DBOOST_LIBRARYDIR=C:/Libraries/boost_1_66_0/lib64-msvc-14.0 -G "Visual Studio 14 2015 Win64" -DIPHLPAPI_LIBRARY="C:/Program Files (x86)/Windows Kits/10/Lib/10.0.14393.0/um/x64/iphlpapi.lib" -DWINSOCK2_LIBRARY="C:/Program Files (x86)/Windows Kits/10/Lib/10.0.14393.0/um/x64/WS2_32.lib" -DGIT_COMMIT=%GIT_COMMIT% -DRAIBLOCKS_SECURE_RPC=ON -DOPENSSL_ROOT_DIR="C:/LibreSSL"

- ps: >-
    $size_t=select-string -path ".\bootstrap_weights.cpp" -Pattern "rai_bootstrap_weights_size"| foreach {$_.Line}
    
    $old_size_t = "extern const size_t rai_bootstrap_weights_size;"
    
    $char=select-string -path ".\bootstrap_weights.cpp" -Pattern "char rai_bootstrap_weights"| foreach {$_.Line}
    
    $old_char = [regex]::Escape("extern const char rai_bootstrap_weights[];") 
    
    select-string -path ".\rai\node\node.cpp" -Pattern $old_size_t -SimpleMatch | %{$curpath=$_.path; (get-content $curpath -Raw) -replace $old_char, $char| Out-File $curpath}
    
    select-string -path ".\rai\node\node.cpp" -Pattern $old_size_t -SimpleMatch | %{$curpath=$_.path; (get-content $curpath -Raw) -replace $old_size_t, $size_t| Out-File $curpath}

build:
  parallel: true  
  project: rai_node.vcxproj
  verbosity: quiet
after_build:
- cmd: 7z a -tzip -mx=9 node-win32.zip "%APPVEYOR_BUILD_FOLDER%/Release/rai_node.exe"
artifacts:
- path: node-win32.zip
  name: node-win32
